#!/bin/bash
# Description: Thinstation Utility to strip out extra files from a binary Package
# URL: http://www.thinstation.org
# Maintainer: Donald A. Cupp Jr. (don cupp jr at ya hoo dot com)


show_help()
{
echo "
This utility is designed to simplify the folder layout of a crux port into a
ts package. It will decompress the compiled port archive the belongs to the
specified package and mangle it for integration into thinstation. By default,
the destination will be in $TSWRKNG/packages/(specified package) folder.
This can be overriden with the -t or --temp (path to temp folder)
syntax.

Usage: repackage (-t (path to temp folder)) (crux port)

"
}

get_opts()
{
	if [ -z "$1" ] ; then show_help ; exit 255 ; fi
	until [ -z "$1" ] ; do
		case "$1" in
			-h|--help)		show_help ; exit 255 ;;
			-t|--temp)		temp_folder="$2" ; shift ;;
			-e|--env)		from_env ; exit 0 ;;
			-c|--clean)		clean ; exit 0 ;;
			*)			package="$1" ;;
		esac
		shift
	done
}

package_path()
{
	if [ "$temp_folder" != "" ] ; then
		pkgpath="$temp_folder/$package"
	else
		pkgpath="$TSWRKNG/packages/$package"
	fi
}

extract_archive()
{
	if [ ! -d $pkgpath ] ; then
		mkdir -p $pkgpath
	fi
	ppath=`prt-get path $package`
	version=`prt-get current $package`
	archive=$ppath/${package}#$version.pkg.tar.gz
	tar -zxf $archive -C $pkgpath 2>/dev/null
}

shallow_usr()
{
	for usr_dir in usr usr/local ; do
		for essential_dir in sbin bin lib etc var ; do
			if [ -d $pkgpath/$usr_dir/$essential_dir ] && [ -n "`ls -A $pkgpath/$usr_dir/$essential_dir`" ]; then
				mkdir -p $pkgpath/$essential_dir
				cp -Prfd $pkgpath/$usr_dir/$essential_dir $pkgpath/.
				rm -rf $pkgpath/$usr_dir/$essential_dir
			fi
		done
	done
}

redirect_sbin()
{
	if [ -e $pkgpath/sbin ] && [ -n "`ls -A $pkgpath/sbin`" ]; then
		mkdir -p $pkgpath/bin
		cp -Prfd $pkgpath/sbin/* $pkgpath/bin
		rm -rf $pkgpath/sbin
	fi
}

redirect_shared()
{
	for share_dir in share usr/share usr/local/share ; do
		if [ -d $pkgpath/$share_dir ] && [ -n "`ls -A $pkgpath/$share_dir`" ]; then
			if [ -d $pkgpath/$share_dir/dbus-1 ] && [ -n "`ls -A $pkgpath/$share_dir/dbus-1`" ]; then
				mkdir -p $pkgpath/etc/dbus-1
				cp -Prfd $pkgpath/$share_dir/dbus-1/* $pkgpath/etc/dbus-1
				rm -rf $pkgpath/$share_dir/dbus-1
			fi
			for shared_object in `ls --color=never $pkgpath/$share_dir` ; do
				mkdir -p $pkgpath/lib
				cp -Prfd $pkgpath/$share_dir/$shared_object $pkgpath/lib/.
				rm -rf $pkgpath/$share_dir/$shared_object
			done
		fi
		if [ -d $pkgpath/$share_dir ] ; then
			rmdir $pkgpath/$share_dir
		fi
	done
}

extra_dirs()
{
	extra_dirs="man pkgconfig aclocal gtk-doc help vala gir-1.0 girepository-1.0 locale bash-completion cmake"
	if [ "$package" != "python" ] ; then
		extra_dirs="$extra_dirs include"
	fi
	for extra_dir in $extra_dirs ; do
		if [ -d $pkgpath/$extra_dir ] ; then
			rm -rf $pkgpath/$extra_dir
		fi
		if [ -d $pkgpath/usr/$extra_dir ] ; then
			rm -rf $pkgpath/usr/$extra_dir
		fi
		if [ -d $pkgpath/usr/local$extra_dir ] ; then
			rm -rf $pkgpath/usr/local/$extra_dir
		fi
		if [ -d $pkgpath/lib/$extra_dir ] ; then
			rm -rf $pkgpath/lib/$extra_dir
		fi
	done
	for  include in include local/include ; do
		if [ -d $pkgpath/usr/$include ] ; then
			cp -Prfd $pkgpath/usr/$include/* $pkgpath/lib/.
			rm -rf $pkgpath/usr/$include
			ln -sf /lib $pkgpath/usr/$include
		fi
	done
}

extra_files()
{
	find $pkgpath -name *.a -delete
	find $pkgpath -name *.la -delete
}

remove_empty()
{
	find $pkgpath -type d -empty -delete
}

clean()
{
	if [ -n "$PACKAGE" ] && [ -e ./packages/$PACKAGE ]; then
		for object in `ls -A --color=never ./packages/$PACKAGE |grep -E -v 'build|.dna|.gitignore|dependencies'`; do
			rm -rf ./packages/$PACKAGE/$object
		done
		rm -f ./packages/$PACKAGE/build/installed
	else
		echo "$PACKAGE does not exist"
		exit 1
	fi
}

cut_bloat()
{
	for bloat in $DROP_FILES; do
		find $INSTALLDIR -type f -name $bloat -delete
	done
	for bloat in $DROP_FILES; do
		find $INSTALLDIR -type l -name $bloat -delete
	done
	for bloat in $DROP_DIRS; do
		rm -rf $INSTALLDIR/$bloat
	done
}

create_empty()
{
	for folder in $CREATE_EMPTY_DIRS; do
		mkdir -p $INSTALLDIR/$folder
	done
}

merge_trunk()
{
	if [ -e $INSTALLDIR/build/extra ]; then
		for dir in `find $INSTALLDIR/build/extra -type d |cut -d '/' -f6-`; do
			mkdir -p $INSTALLDIR/$dir
		done
		for file in `find $INSTALLDIR/build/extra ! -type d |cut -d '/' -f6-`; do
			if [ -e $INSTALLDIR/$file ]; then
				rm $INSTALLDIR/$file
			fi
			ln $INSTALLDIR/build/extra/$file $INSTALLDIR/$file
		done
	fi
}

from_env()
{
	INSTALLDIR=./packages/$PACKAGE
	temp_folder=./build-$PACKAGE
	for package in $PORTS; do
		main
		cp -Prf $temp_folder/$package/* $INSTALLDIR/.
		rm -rf $temp_folder
	done
	cut_bloat
	create_empty
	merge_trunk
	touch $INSTALLDIR/build/installed
}

remove_libs()
{
	if [ -e $pkgpath/lib ]; then
		find $pkgpath/lib -mindepth 1 -maxdepth 1 -name lib\*.so\* -delete
	fi
}

main()
{
	package_path
	extract_archive
	shallow_usr
	redirect_shared
	extra_dirs
	extra_files
	remove_empty
#	remove_libs
}

get_opts $@
main $@
exit 0
