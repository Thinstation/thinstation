#!/bin/sh

. /etc/thinstation.env
. $TS_GLOBAL
. /etc/splash.functions

echo_log "\n\nWelcome to Thinstation Linux $TS_VERSION"

no_package()
{
	force_splash_exit
	echo_log -n -d "ERROR: Package $type doesn't exist, aborting bootup. Check your "
	echo_log -n -d "thinstation.conf file and build.conf file to make sure you have the "
	echo_log -n -d "package loaded."
	while true; do
		sleep 10000
	done
}

case $1 in
	0)
	# Start each session
	# Cleanup files if already existing
	if [ -e $WKDIR/windowapps ] ; then
		rm $WKDIR/windowapps
	fi
	if [ -e $WKDIR/consoleapps ] ; then
		rm $WKDIR/consoleapps
	fi
	if [ -e $WKDIR/*.autostart ] ; then
		rm $WKDIR/*.autostart
	fi

	(cat $WKDIR/session) |
	while read type title screen position workspace autostart custom icon server options ; do
		if [ -e /etc/cmd/$type.wm ] && [ -z "$WMNAME" ] ; then
			export WMSCREEN=$screen
			export WMNAME=$type
			echo "WMNAME"="$type" >> $TS_RUNTIME
		fi
		autostart=`make_caps $autostart`
		case $autostart in
			ON)
				if [ -e /etc/init.d/$type ] ; then
					# Set screen variables
					export DISPLAY=:$screen.0
					export DISPLAY_NUMBER=$screen
					export WMWORKSPACE=$workspace
					export POSITION=$position
					if [ "$server" = "." ] ; then server= ; fi
					if [ "$options" = "." ] ; then options= ; fi
					if [ ! -e /etc/console/$type ] ; then
						if [ -n "$WMNAME" ] && [ "$type" != "$WMNAME" ] && [ "$screen" == "$WMSCREEN" ] ; then
							echo "pkg auto $type \"$server\" \"$options\" \"$WMWORKSPACE\" &" >> $WKDIR/$WMNAME.autostart
							echo "sleep .2" >> $WKDIR/$WMNAME.autostart
						else
							echo "export DISPLAY=$DISPLAY" >> $WKDIR/windowapps
							echo "export DISPLAY_NUMBER=$DISPLAY_NUMBER" >> $WKDIR/windowapps
							echo "pkg console $type \"$server\" \"$options\" &" >> $WKDIR/windowapps
						fi
					else
						echo "pkg console $type \"$server\" \"$options\"" >> $WKDIR/consoleapps
					fi
				else
					no_package
				fi
			;;
			*)
				touch /tmp/BOOTMENU
			;;
		esac
	done
	if [ -e $WKDIR/windowapps ] ; then
		. $WKDIR/windowapps
	fi
	if [ -e $WKDIR/consoleapps ] ; then
		. $WKDIR/consoleapps
	fi
	# Start Menu session
	if [ ! -e $WKDIR/windowapps ] && [ -e /tmp/BOOTMENU ] ; then
		splash_exit
		while [ ! -e /tmp/shutdown ] ; do
			pkg console menu
			. $TS_GLOBAL
		done
		rm /tmp/BOOTMENU
	fi
	wait
	;;
esac
